name: Lint and Format Check

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }} # Checkout head_ref for PRs, ref_name for pushes

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Linting
        id: lint_check
        continue-on-error: true
        run: |
          echo "::group::Running ESLint Check"
          npm run lint
          echo "::endgroup::"

      - name: Fix Linting Issues
        if: steps.lint_check.outcome == 'failure'
        run: |
          echo "::notice::Linting errors detected. Applying auto-fixes..."
          npm run lint:fix

      - name: Check Formatting
        id: format_check
        continue-on-error: true
        run: |
          echo "::group::Running Prettier Check"
          npm run format:check
          echo "::endgroup::"

      - name: Fix Formatting Issues
        if: steps.format_check.outcome == 'failure'
        run: |
          echo "::notice::Formatting issues detected. Applying auto-formatting..."
          npm run format

      - name: Verify Fixes
        if: steps.lint_check.outcome == 'failure' || steps.format_check.outcome == 'failure'
        run: |
          echo "::group::Verifying fixes..."
          npm run lint && npm run format:check
          echo "::endgroup::"

      - name: Commit and Push changes
        uses: EndBug/add-and-commit@v9
        if: steps.lint_check.outcome == 'failure' || steps.format_check.outcome == 'failure'
        with:
          message: "chore: auto-fix linting and formatting issues"
          default_author: github_actions

      - name: Generate Workflow Summary
        if: always()
        run: |
          echo "## Lint & Format Report ðŸ“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.lint_check.outcome }}" == "success" ]; then
            echo "### ESLint: âœ… Clean" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" == "success" ]; then
            echo "### ESLint: âŒ Errors Found (Auto-fixed ðŸ› ï¸)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ESLint: âŒ Errors Found (Auto-fix failed âš ï¸)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.format_check.outcome }}" == "success" ]; then
            echo "### Prettier: âœ… Clean" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" == "success" ]; then
            echo "### Prettier: âŒ Issues Found (Auto-formatted ðŸ› ï¸)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Prettier: âŒ Issues Found (Auto-format failed âš ï¸)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> [!NOTE]" >> $GITHUB_STEP_SUMMARY
          echo "> If any issues were fixed, they have been automatically committed to your branch." >> $GITHUB_STEP_SUMMARY